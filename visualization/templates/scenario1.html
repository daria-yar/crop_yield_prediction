{% extends "base.html" %}

{% block title %}Временные ряды - Прогноз урожайности{% endblock %}

{% block content %}
<div class="hero-section text-center" style="padding: 40px 0;">
    <div class="container">
        <h1 class="h2 fw-bold mb-2">
            <i class="fas fa-chart-line me-2"></i>
            Сценарий 1: Временные ряды
        </h1>
        <p class="mb-0">Визуализация динамики метеопараметров и NDVI</p>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-filter me-2"></i>
                    Параметры запроса
                </div>
                <div class="card-body">
                    <form id="scenario1-form">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Регион</label>
                            <select class="form-select" id="region" required>
                                <option value="">Выберите регион</option>
                                <option value="Пензенская область">Пензенская область</option>
                                <option value="Тамбовская область">Тамбовская область</option>
                                <option value="Тульская область">Тульская область</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Район</label>
                            <select class="form-select" id="district" required disabled>
                                <option value="">Сначала выберите регион</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Год</label>
                            <select class="form-select" id="year" required>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                                <option value="2019">2019</option>
                                <option value="2018">2018</option>
                                <option value="2017">2017</option>
                                <option value="2016">2016</option>
                                <option value="2015">2015</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Параметр</label>
                            <select class="form-select" id="param" required>
                                <option value="ndvi">NDVI</option>
                                <option value="mean_temp">Температура</option>
                                <option value="mean_temp_historical">Историческая температура</option>
                                <option value="mean_temp_acc">Накопленная температура</option>
                                <option value="mean_temp_acc_historical">Накопленная историческая температура</option>
                                <option value="mean_prec">Осадки</option>
                                <option value="mean_prec_historical">Исторические осадки</option>
                                <option value="mean_prec_acc">Накопленные осадки</option>
                                <option value="mean_prec_acc_historical">Накопленные исторические осадки</option>
                                <option value="mean_rh">Влажность</option>
                                <option value="mean_rh_historical">Историческая влажность</option>
                                <option value="mean_p">Давление</option>
                                <option value="mean_snod">Глубина снега</option>
                                <option value="mean_snod_historical">Историческая глубина снега</option>
                                <option value="mean_snowc">Доля покрытия снегом</option>
                                <option value="mean_snowc_historical">Историческая доля покрытия снегом</option>
                                <option value="mean_sdswr">Солнечная радиация</option>
                                <option value="mean_sdlwr">Тепловое излучение атмосферы</option>
                                <option value="mean_tmpgr10">Температура почвы на глубине 10 см</option>
                                <option value="mean_soilw10">Влажность почвы на глубине 10 см</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-chart-line me-2"></i>
                            Построить график
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-image me-2"></i>
                    Результат
                </div>
                <div class="card-body">
                    <div id="result-container">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-chart-line fa-3x mb-3"></i>
                            <p>Выберите параметры и нажмите "Построить график"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/districts.js') }}"></script>
<script>
updateDistricts('region', 'district');

document.getElementById('scenario1-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const resultContainer = document.getElementById('result-container');
    showLoading('result-container');
    
    const data = {
        region: document.getElementById('region').value,
        district: document.getElementById('district').value,
        year: parseInt(document.getElementById('year').value),
        param: document.getElementById('param').value
    };
    
    try {
        const response = await fetch('/api/scenario1', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'OK') {
            resultContainer.innerHTML = `
                <div class="graph-container">
                    <img src="data:image/png;base64,${result.image}" alt="График временного ряда">
                </div>
                <div class="row mt-3">
                    <div class="col-md-4 text-center">
                        <div class="stat-label">Район</div>
                        <div class="fw-bold">${result.district}</div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="stat-label">Год</div>
                        <div class="fw-bold">${result.year}</div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="stat-label">Точек данных</div>
                        <div class="fw-bold">${result.data_length}</div>
                    </div>
                </div>
            `;
        } else {
            showError('result-container', result.message || 'Неизвестная ошибка');
        }
    } catch (error) {
        showError('result-container', error.message);
    }
});
</script>
{% endblock %}